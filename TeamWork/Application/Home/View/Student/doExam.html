<include file="Index/studentheader"/>
<js href="__PUBLIC__/assets/js/react.js"/>
<js href="__PUBLIC__/assets/js/react-dom.js"/>
<js href="__PUBLIC__/assets/js/browser.js"/>
<style>
    h2,table,tr {
      text-align: center;
    }
</style>
  <br/>
    <div class="am-panel am-panel-default">
        <div class="am-panel-hd">
            <h2 class="am-panel-title">考试</h2>
        </div>
        <div id="examList">
        </div>
        <!-- <table class="am-table"> --> 
        <!--     <tbody ></tbody> -->
        <!-- </table> -->
        <div class="am-panel-footer">
            <hr/>
        </div>
    </div>
    <div class="am-modal am-modal-no-btn" tabindex="-1" id="my-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">你的成绩
                <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
            </div>
            <div id="score-content" class="am-modal-bd">
            </div>
        </div>
    </div>
<include file="Index/footer"/>

<script type="text/babel">
    var ExamItem = React.createClass({
      getInitialState: function() {
        return {answer: this.props.answer, score: 0,sumed: false};
      },
      finishQuestion: function(event) {
        if(event.target.value == this.state.answer){
            this.setState({score: 1});
        }            
      },
      setSum: function() {
        if(!this.state.sumed) {
            this.props.callbackParent(this.state.score);
            if(this.state.score == 1) {
                this.setState({sumed: true});
            }
        }
      },
      render: function() {
        return (
          <tr className="">
              <td>{this.props.text}</td>
              <td>
                 <input type="text" onChange={this.finishQuestion} onBlur={this.setSum}/>
              </td>
          </tr>
        );
      }
    }); 

    var ExamTable = React.createClass({
      getInitialState: function() {
        return {data: [], question_id: this.props.question_id, sum: 0, second: 0};
      },
      loadQuestionData: function() {
          $.ajax({
              url: '{:U("/Home/Student/getQuestionContent")}',
              dataType: 'json',
              type: 'POST',
              data: {
                  question_id: this.state.question_id
              },
              success: function(response) {
                this.setState({data: response});
              }.bind(this),
              error: function(xhr, status, err) {
                console.error(status, err.toString());
              }.bind(this)
          });
          var time = new Date();
          var time_second = time.getSeconds();
          this.setState({second: time_second});
      },
      onChildChanged: function(score) {
        this.setState({sum: this.state.sum + score});
      },
      componentDidMount: function() {
        this.loadQuestionData();
      },
      submitExam: function() {
        var student_id = "{:I('session.student')['student_id']}";
        var exam_id = "{:I('param.exam_id')}";
        var score = parseFloat(this.state.sum) / parseFloat(this.state.data.length) * 100;
        var end_time = new Date();
        var spend_time = end_time.getSeconds() - this.state.second;
          $.ajax({
              url: '{:U("/Home/Student/submitExam")}',
              dataType: 'json',
              type: 'POST',
              data: {
                student_id: student_id,
                exam_id: exam_id,
                spend_time: spend_time,
                score: score
              },
              success: function(response) {
                console.log(response.message.toString());
              }.bind(this),
              error: function(xhr, status, err) {
                console.error(status, err.toString());
              }.bind(this)
          });
        $("#score-content").text(score);
        $("#my-modal").modal("open");
      },
      render: function() {
        var childChangeFunc = this.onChildChanged;
        return (
          <div>
              <table className="am-table">
                  <tbody>
                      {this.state.data.map(function(d,i){
                          return <ExamItem key={i} text={d.text} answer={d.answer} callbackParent={childChangeFunc}/> 
                      })}
                  </tbody>
              </table>
              <button className="am-btn am-btm-success am-u-centered" onClick={this.submitExam}>交卷</button>
          </div>
        );
      }

    });

    ReactDOM.render(
        <ExamTable question_id ="{:I('param.question_id')}"/>,
        document.getElementById('examList')
    );
</script>
