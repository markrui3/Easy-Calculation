<include file="Index/header"/>
<style>
    .list-title {
      text-align: center;
      padding: 20px;
    }
    #examList {
      text-align: center;
    }
    th {
      text-align: center;
    }
</style>
<body>
    <header class="am-topbar am-topbar-fixed-top">
        <div class="am-container">
            <h1 class="am-topbar-brand">教师模块 </h1>
            <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-secondary am-show-sm-only" data-am-collapse="{target: '#collapse-head'}">
                <span class="am-sr-only">导航切换</span>
                <span class="am-icon-bars"></span>
            </button>
            <div class="am-collapse am-topbar-collapse" id="collapse-head">
                <ul class="am-nav am-nav-pills am-topbar-nav">
                    <li><a href="{:U("Home/Teacher/index")}">首页</a></li>
                    <li><a href="{:U("Home/Teacher/studentList")}">学生</a></li>
                    <li><a href="{:U("Home/Teacher/questionList")}">试题</a></li>
                    <li class="am-active am-dropdown" data-am-dropdown>
                        <a class="am-dropdown-toggle" data-am-dropdown-toggle href="javascript:;">
                            考试 <span class="am-icon-caret-down"></span>
                        </a>
                        <ul class="am-dropdown-content">
                            <li><a href="{:U("Home/Teacher/examList")}">已完成</a></li>
                            <li class="am-active"><a href="#">进行中</a></li>
                        </ul>
                    </li>
                </ul>

                <if condition="session('teacher')">
                    <div class="am-topbar-right">
                        <button class="am-btn am-btn-secondary am-topbar-btn am-btn-sm">
                            <span class="am-icon-user"></span>
                            <a href="#"> {:I('session.teacher')['username']}</a>
                        </button>
                    </div>
                <else />
                    <div class="am-topbar-right">
                        <button class="am-btn am-btn-secondary am-topbar-btn am-btn-sm">
                            <span class="am-icon-pencil"></span>
                            <a href="{:U("/Home/Teacher/login")}"> 登录</a>
                        </button>
                    </div>
                </if>
            </div>
        </div>
    </header>
    <div class="list-title">
        <h1>考试信息</h1>
    </div>
    <div class="am-container">
        <div class="am-g am-u-lg-centered">
            <table id="examList" class="am-table am-table-bordered">
            </table>
        </div>
    </div>
    <div class="am-modal am-modal-no-btn" tabindex="-1" id="my-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">本次考试得分情况
                <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
            </div>
            <div class="am-modal-bd">
                <table id="examInfoTable" class="am-table am-table-bordered">
                    <thead>
                        <tr>
                            <th>学生编号</th>
                            <th>学生姓名</th>
                            <th>学生得分</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    $(document).ready(function($) {
        $('#examList').append('<thead><tr><th>考试编号</th><th>考试名称</th><th>考题编号</th><th>考试耗时</th><th>学生成绩</th></tr></thead>');
        $.ajax({
            url: '{:U("/Home/Teacher/getProcessingExamList")}',
            type: 'POST',
            dataType: 'json',
            data: {
                teacher_id: '{:I("session.teacher")["teacher_id"]}'
            }
        })
            .done(function(response) {
                $('#examList').DataTable({
                    "bProcessing": true,
                    "bDestroy": true,
                    "sPaginationType" : "full_numbers",
                    "oLanguage" : {
                          "sLengthMenu": "每页显示 _MENU_ 条记录",
                          "sZeroRecords": "抱歉， 没有找到",
                          "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
                          "sInfoEmpty": "没有数据",
                          "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
                          "sZeroRecords": "没有检索到数据",
                           "sSearch": "搜索: &nbsp",
                          "oPaginate": {
                            "sFirst": "首页",
                            "sPrevious": "前一页",
                            "sNext": "后一页",
                            "sLast": "尾页"
                          }
                      },    
                    data: response,
                    columns: [
                        { data: 'exam_id' },
                        { data: 'name' },
                        { data: 'question_id' },
                        { data: 'spend_time' },
                        { data: 'info' }
                    ],
                    columnDefs: [
                        <!-- { -->
                        <!--     "targets": 0, -->
                        <!--     "visible":false -->
                        <!-- }, -->
                        {
                            "targets": -1,
                            "data": null,
                            "render": function (data, type, row, table) {
                                return '<button type="button" class="am-btn am-btn-primary" onclick="getExamInfo(' + data + ')">' +  "状态" + '</button>';
                            }
                        }
                    ]
                } );
            })
            .fail(function() {
                console.log("error");
            })
            .always(function() {
                console.log("complete");
            });
    });

    var myChart = echarts.init(document.getElementById('examInfoContent'));

    function getExamInfo(exam_id){
        $.ajax({
            url: '{:U("/Home/Teacher/getExamInfo")}',
            type: 'POST',
            dataType: 'json',
            data: {
                exam_id: exam_id
            }
        })
            .done(function(response){
                $('#examInfoTable').DataTable({
                    bDestroy: true,
                    paging: false,
                    searching: false,
                    data: response,
                    columns:[
                        { data: 'student_id' },
                        { data: 'student_name' },
                        { data: 'score' }
                    ]
                });
                $("#my-modal").modal("open");
            })
            .fail(function() {
                console.log("error");
            })
            .always(function() {
                console.log("complete");
            });
    }
    function showExamChart(exam_id){
        $.ajax({
            url: '{:U("/Home/Teacher/getExamInfo")}',
            type: 'POST',
            dataType: 'json',
            data: {
                exam_id: exam_id
            }
        })
            .done(function(response){
                var ydata = response.map(function(d) {
                    return d.score;
                });
                var xdata = response.map(function(d) {
                    return d.student_name;
                });
                myChart.clear();
                option = {
                    tooltip : {
                        trigger: 'axis'
                    },
                    calculable : true,
                    xAxis : [
                        {
                            type : 'category',
                            boundaryGap : false,
                            data : xdata
                        }
                    ],
                    yAxis : [
                        {
                            type : 'value',
                            axisLabel : {
                                formatter: '{value}分'
                            }
                        }
                    ],
                    series : [
                        {
                            name:'分数',
                            type:'line',
                            data: ydata,
                            markPoint : {
                                data : [
                                    {type : 'max', name: '最大值'},
                                    {type : 'min', name: '最小值'}
                                ]
                            },
                        }
                    ]
                };
                myChart.setOption(option);
                $("#my-chart-modal").modal("open");
            })
            .fail(function() {
                console.log("error");
            })
            .always(function() {
                console.log("complete");
            });
    }
</script>
